<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>批量二维码生成器</title>
  <!-- 引入React和ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- 引入Babel用于JSX转换 -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- 引入二维码生成库 -->
  <script src="qrcode.min.js"></script>
  <!-- 引入Font Awesome图标库 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- 自定义样式 -->
  <style>
    :root {
      --primary: #1777ff;
      --secondary: #03bdd0;
      --danger: #f83949;
      --info: #fe8e22;
      --neutral-50: #F9FAFB;
      --neutral-100: #F3F4F6;
      --neutral-200: #E5E7EB;
      --neutral-300: #D1D5DB;
      --neutral-400: #9CA3AF;
      --neutral-500: #6B7280;
      --neutral-600: #4B5563;
      --neutral-700: #374151;
      --neutral-800: #1F2937;
      --neutral-900: #111827;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Inter, system-ui, sans-serif;
      font-size: 14px;
      height: 100vh;
      overflow: hidden;
      background-color: var(--neutral-50);
      color: var(--neutral-800);
      transition: background-color 0.2s, color 0.2s;
    }

    /* 全局滚动条样式 - 使用margin负值实现不占位 */
    ::-webkit-scrollbar {
      width: 0px;
      background: transparent;
    }

    /* 滚动容器样式 */
    .scrollable-container {
      position: relative;
      overflow: hidden;
    }

    .scrollable-content {
      height: 100%;
      overflow-y: auto;
      padding-right: 0px;
      margin-right: -17px;
      box-sizing: content-box;
    }

    /* 自定义滚动条 */
    .custom-scrollbar {
      position: absolute;
      right: 2px;
      top: 0;
      width: 6px;
      background: transparent;
      border-radius: 3px;
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
      z-index: 1000;
    }

    .scrollable-container:hover .custom-scrollbar {
      opacity: 1;
    }

    .custom-scrollbar-thumb {
      width: 100%;
      background-color: var(--neutral-300);
      border-radius: 3px;
      transition: background-color 0.2s ease;
    }

    .dark .custom-scrollbar-thumb {
      background-color: var(--neutral-600);
    }

    .custom-scrollbar-thumb:hover {
      background-color: var(--neutral-400);
    }

    .dark .custom-scrollbar-thumb:hover {
      background-color: var(--neutral-500);
    }

    /* Firefox隐藏滚动条 */
    .scrollable-content {
      scrollbar-width: none;
    }

    /* 更简单的方案：直接隐藏滚动条 */
    .content-area {
      overflow-y: auto;
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* IE */
    }

    .content-area::-webkit-scrollbar {
      display: none;
      /* Webkit */
    }

    .preview-container {
      overflow-y: auto;
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* IE */
    }

    .preview-container::-webkit-scrollbar {
      display: none;
      /* Webkit */
    }

    body.dark {
      background-color: var(--neutral-900);
      color: var(--neutral-100);
    }

    #root {
      height: 100%;
    }

    .app-container {
      display: flex;
      height: 100%;
      overflow: hidden;
    }

    .left-panel {
      width: 40%;
      background-color: white;
      border-right: 1px solid var(--neutral-200);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .dark .left-panel {
      background-color: var(--neutral-800);
      border-right-color: var(--neutral-700);
    }

    .right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background-color: var(--neutral-50);
    }

    .dark .right-panel {
      background-color: var(--neutral-900);
    }

    .header {
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(4px);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .dark .header {
      background-color: rgba(31, 41, 55, 0.9);
      border-bottom-color: var(--neutral-700);
    }

    .header-content {
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--neutral-800);
      display: flex;
      align-items: center;
      gap: 8px;
      border-left: 3px solid var(--primary);
      padding-left: 10px;
      line-height: 1;
    }

    .dark .header-title {
      color: var(--neutral-100);
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 10px;
      border: 1px solid var(--neutral-300);
      border-radius: 4px;
      background-color: white;
      color: var(--neutral-700);
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
      border: none;
    }

    .btn-view-mode {
      background-color: transparent !important;
      color: var(--neutral-500);
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      border: 1px solid var(--neutral-300);
      border-radius: 20px;
      padding: 0 20px;
      height: 36px;
    }

    .dark .btn {
      background-color: var(--neutral-700);
      border-color: var(--neutral-600);
      color: var(--neutral-300);
    }

    .dark .btn-icon {
      background-color: transparent;
    }

    .btn-primary {
      background-color: var(--primary);
      color: white;
    }

    .btn-secondary {
      background-color: var(--secondary);
      color: white;
    }

    .btn-info {
      background-color: var(--info);
      color: white;
    }

    .btn-danger {
      background-color: var(--danger);
      color: white;
    }

    .btn-icon {
      padding: 10px;
      width: 40px;
      height: 40px;
      justify-content: center;
    }

    .btn-round {
      border-radius: 50%;
      padding: 8px;
      width: 32px;
      height: 32px;
      justify-content: center;
    }

    .search-container {
      padding: 10px 16px 16px 16px;
      position: relative;
    }

    .search-container-main {
      display: flex;
      justify-content: space-between;
    }

    .search-container-main-inputer {
      position: relative;
      flex: 1;
      margin-right: 14px;
    }

    .btn-add-qr-code {
      width: 80px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .search-input {
      width: 100%;
      padding: 10px 10px 10px 30px;
      border: 1px solid var(--neutral-300);
      border-radius: 4px;
      font-size: 14px;
      background-color: white;
      color: var(--neutral-800);
    }

    .dark .search-input {
      background-color: var(--neutral-700);
      border-color: var(--neutral-600);
      color: var(--neutral-100);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--neutral-400);
      pointer-events: none;
    }

    .dark .search-icon {
      color: var(--neutral-500);
    }

    .search-clear {
      position: absolute;
      right: 28px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--neutral-400);
      cursor: pointer;
      background: none;
      border: none;
    }

    .dark .search-clear {
      color: var(--neutral-500);
    }

    .search-result {
      margin-top: 8px;
      font-size: 12px;
      color: var(--neutral-500);
    }

    .dark .search-result {
      color: var(--neutral-400);
    }

    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: 16px 16px 16px 16px;
    }

    .card {
      background-color: white;
      border-radius: 4px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--neutral-200);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .dark .card {
      background-color: var(--neutral-700);
      border-color: var(--neutral-600);
    }

    .card.selected {
      border-color: var(--primary);
      background-color: rgba(79, 70, 229, 0.05);
    }

    .dark .card.selected {
      background-color: rgba(79, 70, 229, 0.1);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-weight: 500;
      color: var(--neutral-800);
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      font-size: 18px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .dark .card-title {
      color: var(--neutral-100);
    }

    .card-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .card-content {
      overflow: hidden;
      transition: all 0.3s ease-in-out;
    }

    .card-content.collapsed {
      max-height: 0;
      opacity: 0;
    }

    .card-content.expanded {
      max-height: 400px;
      opacity: 1;
      padding-top: 20px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 12px;
      color: var(--neutral-500);
      margin-bottom: 6px;
    }

    .dark .form-label {
      color: var(--neutral-400);
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--neutral-300);
      border-radius: 4px;
      font-size: 14px;
      background-color: white;
      color: var(--neutral-800);
      transition: all 0.2s;
    }

    .dark .form-input {
      background-color: var(--neutral-600);
      border-color: var(--neutral-600);
      color: var(--neutral-100);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-textarea {
      resize: none;
      overflow: hidden;
      min-height: 40px;
      word-break: break-all;
    }

    .empty-state {
      text-align: center;
      color: var(--neutral-500);
      padding: 48px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .dark .empty-state {
      color: var(--neutral-400);
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 24px;
      color: var(--neutral-300);
    }

    .dark .empty-icon {
      color: var(--neutral-600);
    }

    .empty-title {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 12px;
    }

    .preview-container {
      padding: 24px;
      flex: 1;
    }

    .preview-single {
      max-width: 400px;
      margin: 0 auto;
      background-color: white;
      border-radius: 4px;
      padding: 24px;
    }

    .dark .preview-single {
      background-color: var(--neutral-800);
    }

    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
    }

    .preview-card {
      background-color: white;
      border-radius: 4px;
      padding: 20px;
      text-align: center;
      transition: all 0.2s;
    }

    .dark .preview-card {
      background-color: var(--neutral-800);
    }

    .qr-canvas {
      border: 1px solid var(--neutral-100);
      border-radius: 4px;
      padding: 12px;
      background-color: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .dark .qr-canvas {
      border-color: var(--neutral-700);
    }

    .qr-info {
      margin-top: 16px;
    }

    .qr-name {
      font-weight: 500;
      color: var(--neutral-800);
      word-break: break-all;
      font-size: 14px;
    }

    .dark .qr-name {
      color: var(--neutral-100);
    }

    .qr-url {
      color: var(--primary);
      font-size: 14px;
      margin-bottom: 8px;
      word-break: break-all;
    }

    .qr-time {
      font-size: 12px;
      color: var(--neutral-500);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      margin-top: 6px;
      font-weight: normal;
      margin-bottom: 10px;
    }

    .dark .qr-time {
      color: var(--neutral-400);
    }

    .qr-actions {
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .modal {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 16px;
    }

    .modal-content {
      background-color: white;
      border-radius: 4px;
      padding: 24px;
      max-width: 640px;
      width: 100%;
      max-height: 90vh;
      overflow: auto;
    }

    .dark .modal-content {
      background-color: var(--neutral-800);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--neutral-800);
    }

    .dark .modal-title {
      color: var(--neutral-100);
    }

    .modal-close {
      padding: 8px;
      background: none;
      border: none;
      color: var(--neutral-600);
      cursor: pointer;
      border-radius: 4px;
    }

    .dark .modal-close {
      color: var(--neutral-300);
    }

    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
      transition: all 0.3s;
      z-index: 100;
    }

    .notification.success {
      background-color: var(--secondary);
    }

    .notification.error {
      background-color: var(--danger);
    }

    .notification.info {
      background-color: var(--info);
    }

    /* 删除确认弹窗样式 */
    .delete-confirm-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10001;
    }

    .delete-confirm-modal {
      background: white;
      border-radius: 4px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .dark .delete-confirm-modal {
      background: var(--neutral-800);
      color: var(--neutral-100);
    }

    .delete-confirm-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--danger);
    }

    .delete-confirm-message {
      color: var(--neutral-600);
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .dark .delete-confirm-message {
      color: var(--neutral-300);
    }

    .delete-confirm-qr-name {
      font-weight: 600;
      color: var(--neutral-800);
      background: var(--neutral-100);
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
      margin: 0 4px;
    }

    .dark .delete-confirm-qr-name {
      color: var(--neutral-100);
      background: var(--neutral-700);
    }

    .delete-confirm-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .delete-confirm-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 80px;
    }

    .delete-confirm-btn.cancel {
      background: var(--neutral-200);
      color: var(--neutral-700);
    }

    .delete-confirm-btn.cancel:hover {
      background: var(--neutral-300);
    }

    .dark .delete-confirm-btn.cancel {
      background: var(--neutral-600);
      color: var(--neutral-200);
    }

    .dark .delete-confirm-btn.cancel:hover {
      background: var(--neutral-500);
    }

    .delete-confirm-btn.confirm {
      background: var(--danger);
      color: white;
    }

    .delete-confirm-btn.confirm:hover {
      background: #dc2626;
    }

    .time-info {
      display: flex;
      flex-direction: column;
    }

    .url-display {
      background-color: var(--neutral-50);
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 8px;
      word-break: break-all;
      color: var(--primary);
      font-size: 14px;
    }

    .dark .url-display {
      background-color: var(--neutral-700);
    }

    .text-center {
      text-align: center;
    }

    .text-lg {
      font-size: 18px;
    }

    .font-semibold {
      font-weight: 600;
    }

    .font-medium {
      font-weight: 500;
    }

    .mb-6 {
      margin-bottom: 24px;
    }

    .mb-2 {
      margin-bottom: 8px;
    }

    .flex {
      display: flex;
    }

    .flex-col {
      flex-direction: column;
    }

    .items-center {
      align-items: center;
    }

    .justify-center {
      justify-content: center;
    }

    .gap-1 {
      gap: 4px;
    }

    .gap-2 {
      gap: 8px;
    }

    .gap-3 {
      gap: 12px;
    }

    .break-all {
      word-break: break-all;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const App = () => {
      // localStorage 存储键
      const STORAGE_KEY = "qr_codes_data";

      // 从 localStorage 加载数据，如果没有则使用默认数据
      const loadFromStorage = () => {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (stored) {
            const data = JSON.parse(stored);
            // 确保每个项目都有必要的字段
            return data.map(item => ({
              id: item.id,
              name: item.name || "",
              url: item.url || "",
              createdAt: item.createdAt || new Date().toISOString(),
              updatedAt: item.updatedAt || new Date().toISOString()
            }));
          }
        } catch (error) {
          console.error("加载本地存储失败:", error);
        }
        // 返回默认数据
        const now = new Date().toISOString();
        return [
          {
            id: 1,
            name: "示例链接",
            url: "https://example.com",
            createdAt: now,
            updatedAt: now
          }
        ];
      };

      // 保存到 localStorage
      const saveToStorage = (data) => {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (error) {
          console.error("保存到本地存储失败:", error);
        }
      };

      const [qrCodes, setQrCodes] = React.useState(loadFromStorage());
      const [selectedId, setSelectedId] = React.useState(() => {
        const loaded = loadFromStorage();
        return loaded.length > 0 ? loaded[0].id : 1;
      });
      const [viewMode, setViewMode] = React.useState(() => {
        // 从localStorage读取预览模式设置
        const saved = localStorage.getItem("viewMode");
        return saved || "single";
      });
      const [collapsedCards, setCollapsedCards] = React.useState(() => {
        // 从localStorage读取折叠状态
        try {
          const saved = localStorage.getItem("collapsedCards");
          return saved ? new Set(JSON.parse(saved)) : new Set();
        } catch (error) {
          return new Set();
        }
      });
      const [searchTerm, setSearchTerm] = React.useState(() => {
        // 从localStorage读取搜索关键词
        return localStorage.getItem("searchTerm") || "";
      });
      const [isDarkMode, setIsDarkMode] = React.useState(() => {
        // 从localStorage读取主题设置，默认为浅色模式
        const saved = localStorage.getItem("theme");
        return saved === "dark";
      });
      const [enlargedQrCode, setEnlargedQrCode] = React.useState(null); // 放大查看的二维码
      const [notification, setNotification] = React.useState({
        show: false,
        message: "",
        type: "success",
      });
      const [deleteConfirm, setDeleteConfirm] = React.useState({ 
        show: false, 
        qrCode: null 
      });

      // 自动保存到localStorage
      React.useEffect(() => {
        saveToStorage(qrCodes);
      }, [qrCodes]);

      // 主题切换effect
      React.useEffect(() => {
        const html = document.documentElement;
        const body = document.body;
        if (isDarkMode) {
          body.classList.add('dark');
          localStorage.setItem("theme", "dark");
        } else {
          body.classList.remove('dark');
          localStorage.setItem("theme", "light");
        }
      }, [isDarkMode]);

      // 保存预览模式到localStorage
      React.useEffect(() => {
        localStorage.setItem("viewMode", viewMode);
      }, [viewMode]);

      // 保存折叠状态到localStorage
      React.useEffect(() => {
        try {
          localStorage.setItem("collapsedCards", JSON.stringify(Array.from(collapsedCards)));
        } catch (error) {
          console.error("保存折叠状态失败:", error);
        }
      }, [collapsedCards]);

      // 保存搜索关键词到localStorage
      React.useEffect(() => {
        localStorage.setItem("searchTerm", searchTerm);
      }, [searchTerm]);



      // 切换主题
      const toggleTheme = () => {
        setIsDarkMode(prev => !prev);
      };

      // 自动调整textarea高度的工具函数
      const adjustTextareaHeight = (element) => {
        if (element && element.tagName === 'TEXTAREA') {
          element.style.height = 'auto';
          element.style.height = element.scrollHeight + 'px';
        }
      };

      // 调整所有textarea高度
      const adjustAllTextareas = () => {
        // 使用setTimeout确保DOM已经渲染
        setTimeout(() => {
          const textareas = document.querySelectorAll('textarea');
          textareas.forEach(textarea => adjustTextareaHeight(textarea));
        }, 100);
      };

      // 打开二维码放大查看
      const openQrCodeModal = (qrCode) => {
        setEnlargedQrCode(qrCode);
      };

      // 关闭二维码放大查看
      const closeQrCodeModal = () => {
        setEnlargedQrCode(null);
      };

      // 格式化时间显示
      const formatTime = (isoString) => {
        try {
          const date = new Date(isoString);
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / (1000 * 60));
          const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
          const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

          if (diffMins < 1) return "刚刚";
          if (diffMins < 60) return `${diffMins}分钟前`;
          if (diffHours < 24) return `${diffHours}小时前`;
          if (diffDays < 7) return `${diffDays}天前`;

          // 超过7天显示具体日期
          return date.toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'numeric',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        } catch (error) {
          return "未知时间";
        }
      };

      // 显示通知
      const showNotification = (message, type = "success") => {
        setNotification({ show: true, message, type });
        setTimeout(
          () => setNotification((prev) => ({ ...prev, show: false })),
          3000
        );
      };

      // 生成新的ID
      const generateId = () => {
        return Math.max(...qrCodes.map((qr) => qr.id), 0) + 1;
      };

      // 添加新的二维码配置
      const addQrCode = () => {
        const newId = generateId();
        const now = new Date().toISOString();
        const newQrCode = {
          id: newId,
          name: `新二维码 ${newId}`,
          url: "https://example.com",
          createdAt: now,
          updatedAt: now,
        };

        setQrCodes((prev) => [...prev, newQrCode]);
        setSelectedId(newId);
        showNotification("已添加新的二维码配置");
      };

      // 更新二维码配置
      const updateQrCode = (id, data) => {
        setQrCodes((prev) =>
          prev.map((qr) =>
            qr.id === id
              ? { ...qr, ...data, updatedAt: new Date().toISOString() }
              : qr
          )
        );
      };

      // 显示删除确认弹窗
      const showDeleteConfirm = (qrCode) => {
        setDeleteConfirm({ show: true, qrCode });
      };

      // 取消删除
      const cancelDelete = () => {
        setDeleteConfirm({ show: false, qrCode: null });
      };

      // 确认删除二维码配置
      const confirmDelete = () => {
        const { qrCode } = deleteConfirm;
        if (!qrCode) return;

        const newQrCodes = qrCodes.filter((qr) => qr.id !== qrCode.id);
        setQrCodes(newQrCodes);

        // 如果删除的是当前选中的，自动选中第一个
        if (selectedId === qrCode.id && newQrCodes.length > 0) {
          setSelectedId(newQrCodes[0].id);
        }

        setDeleteConfirm({ show: false, qrCode: null });
        showNotification(`配置"${qrCode.name}"已删除`, "success");
      };

      // 切换卡片折叠状态
      const toggleCardCollapse = (id) => {
        setCollapsedCards(prev => {
          const newSet = new Set(prev);
          if (newSet.has(id)) {
            newSet.delete(id);
          } else {
            newSet.add(id);
          }
          return newSet;
        });
      };

      // 搜索过滤功能
      const filteredQrCodes = React.useMemo(() => {
        if (!searchTerm.trim()) return qrCodes;

        return qrCodes.filter(qr =>
          qr.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
          qr.url.toLowerCase().includes(searchTerm.toLowerCase())
        );
      }, [qrCodes, searchTerm]);

      // 组件挂载和数据变化后调整textarea高度
      React.useEffect(() => {
        adjustAllTextareas();
      }, [qrCodes]);

      // 搜索条件变化或折叠状态变化后也需要重新调整
      React.useEffect(() => {
        adjustAllTextareas();
      }, [filteredQrCodes, collapsedCards]);

      // 刷新二维码预览
      const refreshQrCode = (id) => {
        if (id) {
          // 刷新单个二维码
          const qr = qrCodes.find(q => q.id === id);
          if (qr) {
            // 更新时间戳
            setQrCodes(prev =>
              prev.map(item =>
                item.id === id
                  ? { ...item, updatedAt: new Date().toISOString() }
                  : item
              )
            );

            renderQrCode(id, qr.url, `qr-canvas-${id}`);
            if (selectedId === id) {
              renderQrCode(id, qr.url, "main-qr-canvas");
            }
            showNotification(`已刷新 "${qr.name}" 二维码`);
          }
        } else {
          // 刷新所有二维码
          const now = new Date().toISOString();
          setQrCodes(prev =>
            prev.map(item => ({ ...item, updatedAt: now }))
          );

          qrCodes.forEach((qr) => {
            renderQrCode(qr.id, qr.url, `qr-canvas-${qr.id}`);
          });
          if (selectedQrCode) {
            renderQrCode(selectedQrCode.id, selectedQrCode.url, "main-qr-canvas");
          }
          showNotification("已刷新所有二维码");
        }
      };

      // 获取当前选中的二维码配置
      const selectedQrCode =
        qrCodes.find((qr) => qr.id === selectedId) || null;

      // 下载单个二维码 - 文件名包含二维码名称
      const downloadQrCode = (id) => {
        // 查找对应的二维码配置
        const qr = qrCodes.find((q) => q.id === id);
        if (!qr) {
          showNotification("未找到二维码配置", "error");
          return;
        }

        // 创建临时canvas用于下载
        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = 300;
        tempCanvas.height = 300;

        // 生成二维码并下载
        QRCode.toCanvas(
          tempCanvas,
          qr.url,
          {
            width: 300,
            margin: 1,
            color: {
              dark: "#333333",
              light: "#ffffff",
            },
          },
          (error) => {
            if (error) {
              console.error("二维码生成错误:", error);
              showNotification("下载失败，请重试", "error");
              return;
            }

            // 创建下载链接，文件名与配置名称一致
            const link = document.createElement("a");
            // 移除文件名中可能的特殊字符，保持与配置名称一致
            const safeFileName = qr.name.replace(/[^a-zA-Z0-9_\-\u4e00-\u9fa5]/g, "_");
            link.download = `${safeFileName}.png`;
            link.href = tempCanvas.toDataURL("image/png");

            // 触发下载
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification(`已下载: ${qr.name}`);
          }
        );
      };

      // 复制二维码到剪贴板
      const copyQrCode = (id) => {
        // 查找对应的二维码配置
        const qr = qrCodes.find((q) => q.id === id);
        if (!qr) {
          showNotification("未找到二维码配置", "error");
          return;
        }

        // 创建临时canvas用于复制
        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = 300;
        tempCanvas.height = 300;

        QRCode.toCanvas(
          tempCanvas,
          qr.url,
          {
            width: 300,
            margin: 1,
            color: {
              dark: "#333333",
              light: "#ffffff",
            },
          },
          (error) => {
            if (error) {
              console.error("二维码生成错误:", error);
              showNotification("复制失败，请重试", "error");
              return;
            }

            // 将canvas内容转换为图像并复制到剪贴板
            tempCanvas.toBlob((blob) => {
              const item = new ClipboardItem({ "image/png": blob });
              navigator.clipboard
                .write([item])
                .then(() => {
                  showNotification(`已复制 "${qr.name}" 二维码到剪贴板`);
                })
                .catch((err) => {
                  console.error("复制到剪贴板失败:", err);
                  showNotification("复制失败，请重试", "error");
                });
            });
          }
        );
      };

      // 渲染二维码到Canvas（仅用于预览）
      const renderQrCode = (id, text, canvasId) => {
        setTimeout(() => {
          const canvas = document.getElementById(canvasId);
          if (canvas) {
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            QRCode.toCanvas(
              canvas,
              text,
              {
                width: canvas.width,
                margin: 1,
                color: {
                  dark: "#333333",
                  light: "#ffffff",
                },
              },
              (error) => {
                if (error) console.error("二维码预览错误:", error);
              }
            );
          }
        }, 0);
      };

      // 预览相关的渲染逻辑
      React.useEffect(() => {
        if (selectedQrCode) {
          renderQrCode(
            selectedQrCode.id,
            selectedQrCode.url,
            "main-qr-canvas"
          );
        }
      }, [selectedQrCode, viewMode]);

      React.useEffect(() => {
        qrCodes.forEach((qr) => {
          renderQrCode(qr.id, qr.url, `qr-canvas-${qr.id}`);
        });
      }, [qrCodes, viewMode]);

      // 渲染放大模态框中的二维码
      React.useEffect(() => {
        if (enlargedQrCode) {
          // 获取最新的二维码数据
          const currentQrCode = qrCodes.find(qr => qr.id === enlargedQrCode.id);
          if (currentQrCode) {
            renderQrCode(currentQrCode.id, currentQrCode.url, "enlarged-qr-canvas");
            // 更新放大查看的数据
            setEnlargedQrCode(currentQrCode);
          }
        }
      }, [enlargedQrCode, qrCodes]);

      return (
        <div className="app-container">
          {/* 左侧配置面板 */}
          <div className="left-panel">
            <div className="header">
              <div className="header-content">
                <h2 className="header-title">
                  二维码配置
                </h2>
                <div className="header-actions">

                </div>
              </div>

              {/* 搜索框 */}
              <div className="search-container">
                <div className="search-container-main">
                  <div className="search-container-main-inputer">
                    <div className="search-icon">
                      <i className="fas fa-search"></i>
                    </div>
                    <input
                      type="text"
                      className="search-input"
                      placeholder="搜索配置名称或网址"
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                    />
                    {searchTerm && (
                      <button
                        className="search-clear"
                        onClick={() => setSearchTerm("")}
                      >
                        <i className="fas fa-times"></i>
                      </button>
                    )}
                  </div>
                  <button
                    className="btn btn-primary btn-add-qr-code"
                    onClick={addQrCode}
                  >
                    <i className="fas fa-plus"></i>
                  </button>
                </div>

                {searchTerm && (
                  <div className="search-result">
                    找到 {filteredQrCodes.length} 个匹配的配置
                  </div>
                )}
              </div>
            </div>

            <div className="content-area">
              {filteredQrCodes.length === 0 ? (
                <div className="empty-state">
                  <div className="empty-icon">
                    <i className="fas fa-search"></i>
                  </div>
                  <h3 className="empty-title">
                    {searchTerm ? "未找到匹配的配置" : "暂无配置"}
                  </h3>
                  <p>
                    {searchTerm ? "请尝试其他搜索关键词" : "点击“+”添加新的二维码配置"}
                  </p>
                </div>
              ) : (
                filteredQrCodes.map((qr) => {
                  const isCollapsed = collapsedCards.has(qr.id);
                  return (
                    <div
                      key={qr.id}
                      className={`card ${selectedId === qr.id ? 'selected' : ''}`}
                      onClick={() => setSelectedId(qr.id)}
                    >
                      <div className="card-header">
                        <div className="card-title">
                          <div>{qr.name || "未命名配置"}</div>
                          <div className="qr-time">
                            <i className="fas fa-clock"></i>
                            <span>{formatTime(qr.updatedAt)}更新</span>
                          </div>
                        </div>
                        <div className="card-actions">
                          <button
                            className="btn btn-round"
                            onClick={(e) => {
                              e.stopPropagation();
                              // 复制链接而不是二维码图片
                              navigator.clipboard.writeText(qr.url).then(() => {
                                showNotification(`已复制链接: ${qr.name}`);
                              }).catch(() => {
                                showNotification("复制失败，请重试", "error");
                              });
                            }}
                            title="复制链接"
                          >
                            <i className="fas fa-link"></i>
                          </button>
                          <button
                            className="btn btn-round"
                            onClick={(e) => {
                              e.stopPropagation();
                              showDeleteConfirm(qr);
                            }}
                            title="删除"
                          >
                            <i className="fas fa-trash"></i>
                          </button>
                          <button
                            className="btn btn-round"
                            onClick={(e) => {
                              e.stopPropagation();
                              toggleCardCollapse(qr.id);
                            }}
                            title={isCollapsed ? "展开配置" : "折叠配置"}
                          >
                            <i className={`fas ${isCollapsed ? 'fa-chevron-down' : 'fa-chevron-up'}`}></i>
                          </button>
                        </div>
                      </div>

                      <div className={`card-content ${isCollapsed ? 'collapsed' : 'expanded'}`}>
                        <div>
                          <div className="form-group">
                            <label className="form-label">
                              名称
                            </label>
                            <input
                              type="text"
                              className="form-input"
                              value={qr.name}
                              onChange={(e) => {
                                updateQrCode(qr.id, { name: e.target.value });
                              }}
                              onClick={(e) => e.stopPropagation()}
                            />
                          </div>

                          <div className="form-group">
                            <label className="form-label">
                              内容
                            </label>
                            <textarea
                              className="form-input form-textarea"
                              value={qr.url}
                              onChange={(e) => {
                                updateQrCode(qr.id, { url: e.target.value });
                                // 自动调整高度
                                adjustTextareaHeight(e.target);
                              }}
                              onInput={(e) => {
                                // 自动调整高度
                                adjustTextareaHeight(e.target);
                              }}
                              onClick={(e) => e.stopPropagation()}
                              placeholder="输入网址或文本内容"
                              style={{ minHeight: '40px' }}
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })
              )}
            </div>
          </div>

          {/* 右侧预览面板 */}
          <div className="right-panel">
            <div className="header">
              <div className="header-content">
                <h2 className="header-title">
                  二维码预览
                </h2>
                <div className="header-actions">
                  {viewMode === "all" && (
                    <button
                      className="btn btn-icon"
                      onClick={() => refreshQrCode()}
                      title="刷新所有二维码"
                    >
                      <i className="fas fa-sync-alt"></i>
                    </button>
                  )}
                  <button
                    className="btn btn-icon"
                    onClick={toggleTheme}
                    title={isDarkMode ? "切换到浅色模式" : "切换到深色模式"}
                  >
                    <i className={`fas ${isDarkMode ? 'fa-sun' : 'fa-moon'}`}></i>
                  </button>
                  <button
                    className="btn btn-view-mode"
                    onClick={() =>
                      setViewMode(viewMode === "single" ? "all" : "single")
                    }
                    title={viewMode === "single" ? "多码预览" : "单码预览"}
                  >
                    {viewMode === "single" ? "多码预览" : "单码预览"}
                  </button>
                </div>
              </div>
            </div>

            <div className="preview-container">
              {qrCodes.length === 0 ? (
                <div className="empty-state" style={{ height: '100%' }}>
                  <div className="empty-icon">
                    <i className="fas fa-qrcode"></i>
                  </div>
                  <h3 className="empty-title">暂无二维码配置</h3>
                  <p>
                    请在左侧面板点击"+"按钮开始创建
                  </p>
                </div>
              ) : viewMode === "single" && selectedQrCode ? (
                <div className="preview-single">
                  <div className="flex justify-center mb-6">
                    <canvas
                      id="main-qr-canvas"
                      width="350"
                      height="350"
                      className="qr-canvas"
                      onClick={() => openQrCodeModal(selectedQrCode)}
                      title="点击放大查看"
                    ></canvas>
                  </div>
                  <div className="text-center">
                    <div className="text-lg font-semibold mb-2 break-all" style={{ color: 'var(--neutral-800)' }}>
                      {selectedQrCode.name}
                    </div>
                    <div className="qr-url mb-2">
                      {selectedQrCode.url}
                    </div>
                    <div className="qr-time mb-6">
                      <i className="fas fa-clock"></i>
                      <span>更新于 {formatTime(selectedQrCode.updatedAt)}</span>
                    </div>
                    <div className="flex gap-3 justify-center">
                      <button
                        className="btn btn-secondary"
                        onClick={() => refreshQrCode(selectedQrCode.id)}
                        style={{ padding: '12px 24px', borderRadius: '50px' }}
                      >
                        <i className="fas fa-sync-alt"></i>
                      </button>
                      <button
                        className="btn btn-info"
                        onClick={() => copyQrCode(selectedQrCode.id)}
                        style={{ padding: '12px 24px', borderRadius: '50px' }}
                      >
                        <i className="fas fa-copy"></i>
                      </button>
                      <button
                        className="btn btn-primary"
                        onClick={() => downloadQrCode(selectedQrCode.id)}
                        style={{ padding: '12px 24px', borderRadius: '50px' }}
                      >
                        <i className="fas fa-download"></i>
                      </button>
                    </div>
                  </div>
                </div>
              ) : (
                <div className="preview-grid">
                  {qrCodes.map((qr) => (
                    <div
                      key={qr.id}
                      className="preview-card"
                    >
                      <div className="flex justify-center" style={{ marginBottom: '16px' }}>
                        <canvas
                          id={`qr-canvas-${qr.id}`}
                          width="250"
                          height="250"
                          className="qr-canvas"
                          onClick={() => openQrCodeModal(qr)}
                          title="点击放大查看"
                        ></canvas>
                      </div>
                      <div className="qr-name">
                        {qr.name}
                      </div>
                      <div className="qr-time">
                        <i className="fas fa-clock"></i>
                        <span>{formatTime(qr.updatedAt)}</span>
                      </div>
                      <div className="qr-actions">
                        <button
                          className="btn btn-secondary btn-round"
                          onClick={() => refreshQrCode(qr.id)}
                          title="刷新二维码"
                        >
                          <i className="fas fa-sync-alt" style={{ fontSize: '12px' }}></i>
                        </button>
                        <button
                          className="btn btn-info btn-round"
                          onClick={() => copyQrCode(qr.id)}
                          title="复制二维码"
                        >
                          <i className="fas fa-copy" style={{ fontSize: '12px' }}></i>
                        </button>
                        <button
                          className="btn btn-primary btn-round"
                          onClick={() => downloadQrCode(qr.id)}
                          title="下载二维码"
                        >
                          <i className="fas fa-download" style={{ fontSize: '12px' }}></i>
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* 二维码放大查看模态框 */}
          {enlargedQrCode && (
            <div
              className="modal"
              onClick={closeQrCodeModal}
            >
              <div
                className="modal-content"
                onClick={(e) => e.stopPropagation()}
              >
                <div className="modal-header">
                  <h3 className="modal-title">
                    {enlargedQrCode.name}
                  </h3>
                  <button
                    className="modal-close"
                    onClick={closeQrCodeModal}
                  >
                    <i className="fas fa-times" style={{ fontSize: '18px' }}></i>
                  </button>
                </div>

                <div className="flex justify-center mb-6">
                  <canvas
                    id="enlarged-qr-canvas"
                    width="400"
                    height="400"
                    className="qr-canvas"
                  ></canvas>
                </div>

                <div className="text-center mb-6">
                  <div className="url-display">
                    {enlargedQrCode.url}
                  </div>
                  <div className="qr-time">
                    <i className="fas fa-clock"></i>
                    <span>{formatTime(enlargedQrCode.updatedAt)}更新</span>
                  </div>
                </div>

                <div className="flex gap-3 justify-center">
                  <button
                    className="btn btn-secondary"
                    onClick={() => refreshQrCode(enlargedQrCode.id)}
                    style={{ padding: '12px 24px' }}
                  >
                    <i className="fas fa-sync-alt"></i> 刷新二维码
                  </button>
                  <button
                    className="btn btn-info"
                    onClick={() => copyQrCode(enlargedQrCode.id)}
                    style={{ padding: '12px 24px' }}
                  >
                    <i className="fas fa-copy"></i> 复制二维码
                  </button>
                  <button
                    className="btn btn-primary"
                    onClick={() => downloadQrCode(enlargedQrCode.id)}
                    style={{ padding: '12px 24px' }}
                  >
                    <i className="fas fa-download"></i> 下载二维码
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* 删除确认弹窗 */}
          {deleteConfirm.show && (
            <div className="delete-confirm-overlay" onClick={cancelDelete}>
              <div className="delete-confirm-modal" onClick={(e) => e.stopPropagation()}>
                <div className="delete-confirm-title">
                  <i className="fas fa-exclamation-triangle"></i> 确认删除
                </div>
                <div className="delete-confirm-message">
                  确定要删除配置
                  <span className="delete-confirm-qr-name">{deleteConfirm.qrCode?.name}</span>
                  吗？此操作无法撤销。
                </div>
                <div className="delete-confirm-actions">
                  <button className="delete-confirm-btn cancel" onClick={cancelDelete}>
                    取消
                  </button>
                  <button className="delete-confirm-btn confirm" onClick={confirmDelete}>
                    删除
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* 通知组件 */}
          {notification.show && (
            <div
              className={`notification ${notification.type}`}
            >
              <i
                className={
                  notification.type === "success"
                    ? "fas fa-check-circle"
                    : notification.type === "error"
                      ? "fas fa-exclamation-circle"
                      : "fas fa-info-circle"
                }
              ></i>
              <span>{notification.message}</span>
            </div>
          )}
        </div>
      );
    };

    // 渲染应用
    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>

</html>
